# **Скрипт для мониторинга сервера WildFly, базы данных PostgreSQL и системных данных сервера**

## Краткое описание :mag:
Скрипт предназначен для оценки базовых параметров состояния сервера и сервера приложений WildFly, а также баз данных на основе PostgreSQL,  в том числе на отдельном сервере. Рассчитан, данный скрипт, в первую очередь для
мониторинга систем CM5 и CMJ. Позволяет также снимать Thread Dump приложения, при достижении сервером заданных пороговых значений ОЗУ и CPU.

## Основные принципы работы скрипта :computer:
Данный скрипт предполагает запуск через системного демона cron, для его регулярной и автоматической отработки через определенное количество времени. Скрипт собирает определенные системные данные и данные по работе базы данных
PostgreSQL и сервера приложений WildFly, а затем записывает их в свой лог. Все данные имеют свою временную метку для более удобного отслеживания состояния сервера во времени. По умолчанию, временные метки и собственно
собранные данные выделены в логе другим цветом, для более удобного ориентирования в логах, при желании, данные настройки можно изменить во время настройки скрипта. При достижении пороговых значений на сервере, скрипт также
создает Thread Dump и сохраняет его файл в заданной дирректории.

## Возможности скрипта :chart_with_upwards_trend: 
* Мониторинг базовых характеристик сервера – отображение общего объема ОЗУ, используемого объема ОЗУ, процент использования ОЗУ, текущая загрузка ЦП, средняя загрузка ЦП за последние 1, 5, 15 минут.
* Мониторинг сервера приложений WildFly – отображение количества активных сессий к WildFly и время отклика сервлетов.
* Мониторинг базы данных PostgreSQL – отображение количества активных подключений к базе даных, количество активных серверных процессов, наличие активных запросов к базе данных, а также статистика по длительности выполнения последних запросов в базе данных.
* Сбор Thread Dump – возможно вручную задать пороговые значения загруженности ОЗУ и CPU, при которых будет происходить автоматический сбор Thread Dump и сохранении их в заданной директории.

## Системные требования :clipboard:
* ОС на основе Linux
* Версия Bash – 4.4.23 и новее
* JDK версии 1.8.0_352 и новее
* WildFly версии 18 и новее
* PostgreSQL сервер 16 версии и новее
* Наличие на сервере следующих утилит: free, date, awk, grep, mktemp, uptime, psql, curl
* Иметь права суперпользователя root

## Настройка скрипта :wrench:
1. Скачать скрипт
2. Сделать файл скрипта исполняемым
`chmod a+x sys_script.sh`
3. Открыть файл скрипта любым текстовым редактором
`vim sys_script.sh `
`nano sys_script.sh`
4. Отредактировать в текстовом редакторе следующие переменные на актуальные для вашей системы значения и сохранить изменения, не
    обязательные для редактирования переменные отмечены следующим символом (*), переменные, которые имеются в файле скрипта, но не попали в данный список, лучше оставить неизменными:
   ```bash
   HOME_LOG="/root/bin/script_log"            # Директория, где будут храниться логи скрипта
   LOG_FILE="script_log.$(date +%Y.%m.%d)"    # Формат для названия файла лога скрипта (*)
   COLOR_1='\e[32m'    # ANSI-код для цветового оформления в логе собранных данных (*)
   COLOR_2='\e[36m'    # ANSI-код для цветового оформления в логе временных меток (*)
   RESET='\e[0m'       # ANSI-код для возвращения к стандартному цветовому оформлению (*)
   CONDITIONS_OZU=85   # Указывается значение использования ОЗУ, при котором собираются Thread Dump
   CONDITIONS_CPU=85   # Указывается значение нагрузки на CPU, при которой собираются Thread Dump

   # Переменные для подключения и работы Wildfly
   WILDFLY_HOME="/u01/CM/wildfly"            # Домашняя директория WildFly
   HOST="localhost"                          # Адрес сервера с WildFly
   PORT_CLI="9990"                           # Порт на котором работает CLI WildFly
   PORT_APP="8080"                           # Порт на котором есть доступ по сети до самого приложения
   URL="https://10.7.39.16:8080/ssrv-war/"   # URL адрес приложения

   # Переменные для подключения к удаленной БД PostgreSQL
   DB_CM5="cm5_17_new"    # Полное название базы данных CM5
   DB_CMJ="cmj_17_new"    # Полное название базы данных CMJ
   DB_USER="admin"        # Имя пользователя для доступа к базе данных
   DB_PASSWORD="admin"    # Пороль пользователя для доступа к базе данных
   DB_HOST="10.7.39.8"    # Адрес сервера баз данных
   DB_PORT="5432"         # Порт для работы с базой данных

   # Переменные для содания Thread Dump
   DUMP_FILE="thread_dump.$(date +%Y-%m-%d_%H:%M:%S)"    # Формат для названия файла Thread dump (*)
   DUMP_DIR="/u01/CM/wildfly/ThreadDump"                 # Директория, где будут храниться файлы Thread dump
   JAVA_HOME="/u01/CM/liberica-1.8.0_345"                # Домашняя директория Java
   WF_SERVICE="/etc/systemd/system/wildfly.service"      # Полный путь до юнит файла WildFly

   ```
5. Убедиться, что cron в активном состоянии `systemctl status cron.service`
6. Открываем файл crontab для редактирования `crontab -e`
7. Прописываем в нем следующую строчку (в данном примере мы указываем запускать скрипт каждые 5 минут, при
   необходимости, можно задать любую другую периодичность запуска)       
   `*/5 * * * * /путь/до/скрипта.sh `
## Устранение возможных неполадок :exclamation:
При возникновении основной массы возможных неполадок, информация о них будет также записываться в логе скрипта.
Эти сообщения коротко описывают с чем связана данная неполадка, а также имеют код ошибки, ниже представлены для каждого кода ошибки причины их возникновения и основные способы их устранения:
* Error 1 – Не удалось получить данные о количестве подключений к CM5/CMJ. Проверьте, правильно ли у вас заданы
  следующие переменные: $DB_PASSWORD, $DB_HOST, $DB_PORT, $DB_USER, $DB_CM5, $DB_CMJ. Если это не помогло,
  проверьте на сервере базы данных, имеется ли доступ к ней с сервера, на котором запущен скрипт (данные настройки можно проверить в файле pg_hba.conf, которые располагается в основной папке PostgreSQL).
* Error 2 – Не удалось получить данные о количестве активных сессий WildFly. Проверьте, правильно ли заданы
  следующие переменные: $WILDFLY_HOME, $HOST, $PORT_CLI. Если это не помогло, проверьте, запущен ли WildFly на сервере и прошел ли успешный deploy приложения на нем.
* Error 3 – Не удалось получить время отклика сервлета. Проверьте, правильно ли задана переменная $URL. Если это не помогло, попробуйте вручную перейти по этому адресу, и убедиться, что он доступен.
* Error 4 – Не удалось собрать данные из удаленной базы данных PostgreSQL. Проверьте, правильно ли у вас заданы
  следующие переменные: $DB_PASSWORD, $DB_HOST, $DB_PORT, $DB_USER, $DB_CM5, $DB_CMJ. Если это не помогло,
  проверьте на сервере базы данных, имеется ли доступ к ней с сервера, на котором запущен скрипт (данные настройки можно проверить в файле pg_hba.conf, которые располагается в основной папке PostgreSQL), а также запущен ли сам PostgreSQL.
* Error 5 – Не удается собрать Thread Dump когда в этом есть необходимость по заданным условиям. Проверьте
  правильно ли у вас указаны следующие переменные: $WF_SERVICE, $JAVA_HOME. Если это не помогло, проверьте,
  корректно ли заданы данные User в самом юнит файле WildFly, а так же, создан ли данный пользователь у вас на сервере и имеет ли он права, на работу с WildFly.  
